# ===============================================================================
# Azure Stack Node Deployment Workflow
# ===============================================================================
# This workflow defines the sequential deployment steps for a single Azure Stack node.
# Steps: OS Update → Stamp Update → SBE Update → MocArc Update
# Used as a subflow by the main Azure Stack deployment workflow.
# ===============================================================================

workflowId: deploy-node
workflowName: Deploy Azure Stack Node
description: Sequential deployment steps for a single Azure Stack node

nodes:
  # ============================================================================
  # Step 1: OS Update
  # ============================================================================

  - nodeId: os-update
    nodeName: OS Update
    runtimeType: CSharpTask
    scriptContent: |
        var nodeName = (string)GetInput("nodeName") ?? "Unknown";
        Console.WriteLine($"[{nodeName}] Starting OS Update...");
        await Task.Delay(1000); // Simulate OS update
        Console.WriteLine($"[{nodeName}] OS Update completed successfully!");
        SetOutput("osUpdateStatus", "Success");
        SetOutput("osVersion", "Windows Server 2022 - Build 20348.2031");

  # ============================================================================
  # Step 2: Stamp Update
  # ============================================================================

  - nodeId: stamp-update
    nodeName: Stamp Update
    runtimeType: CSharpTask
    scriptContent: |
        var nodeName = (string)GetInput("nodeName") ?? "Unknown";
        Console.WriteLine($"[{nodeName}] Starting Stamp Update...");
        await Task.Delay(800); // Simulate stamp update
        Console.WriteLine($"[{nodeName}] Stamp Update completed successfully!");
        SetOutput("stampUpdateStatus", "Success");
        SetOutput("stampVersion", "2311.1.2");

  # ============================================================================
  # Step 3: SBE Update
  # ============================================================================

  - nodeId: sbe-update
    nodeName: SBE Update
    runtimeType: CSharpTask
    scriptContent: |
        var nodeName = (string)GetInput("nodeName") ?? "Unknown";
        Console.WriteLine($"[{nodeName}] Starting SBE (Software Based Enclave) Update...");
        await Task.Delay(1200); // Simulate SBE update
        Console.WriteLine($"[{nodeName}] SBE Update completed successfully!");
        SetOutput("sbeUpdateStatus", "Success");
        SetOutput("sbeVersion", "1.0.2311.3");

  # ============================================================================
  # Step 4: MocArc Update
  # ============================================================================

  - nodeId: mocarc-update
    nodeName: MocArc Update
    runtimeType: CSharpTask
    scriptContent: |
        var nodeName = (string)GetInput("nodeName") ?? "Unknown";
        Console.WriteLine($"[{nodeName}] Starting MocArc (Azure Arc) Update...");
        await Task.Delay(900); // Simulate MocArc update
        Console.WriteLine($"[{nodeName}] MocArc Update completed successfully!");
        SetOutput("mocArcUpdateStatus", "Success");
        SetOutput("arcVersion", "1.14.0");

        // Set final deployment status
        Console.WriteLine($"[{nodeName}] All deployment steps completed!");
        SetOutput("deploymentStatus", "Success");

# ============================================================================
# Sequential Connections: OS → Stamp → SBE → MocArc
# ============================================================================
connections:
  - sourceNodeId: os-update
    targetNodeId: stamp-update
    triggerMessageType: Complete
    isEnabled: true

  - sourceNodeId: stamp-update
    targetNodeId: sbe-update
    triggerMessageType: Complete
    isEnabled: true

  - sourceNodeId: sbe-update
    targetNodeId: mocarc-update
    triggerMessageType: Complete
    isEnabled: true
