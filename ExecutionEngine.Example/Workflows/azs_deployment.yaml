# ===============================================================================
# Azure Stack Deployment Workflow (Restructured)
# ===============================================================================
# This workflow demonstrates the Azure Stack deployment process with:
# 1. Pre-deployment checks (container with sequential execution)
# 2. Node deployments (container with parallel subflows): Deploy to AzS-Node1, Node2, Node3
# 3. Post-deployment health checks (container with sequential execution)
# ===============================================================================

workflowId: azs-deployment
workflowName: Azure Stack Deployment
description: Complete Azure Stack deployment workflow with containers and subflows

defaultVariables:
  nodeName: "AzS-Node"

nodes:
  # ============================================================================
  # Phase 1: Pre-deployment Checks Container (Sequential Execution)
  # ============================================================================

  - nodeId: pre-deployment-checks
    nodeName: Pre-Deployment Checks
    runtimeType: Container
    configuration:
      ExecutionMode: "Sequential"
      ChildNodes:
        # Child 1: Network check
        - nodeId: check-network
          nodeName: Network Connectivity Check
          type: Task
          runtimeType: CSharp
          assemblyPath: ExecutionEngine.Example.dll
          typeName: ExecutionEngine.Example.Nodes.AzureStackPreCheckNode
          configuration:
            checkType: "network"

        # Child 2: Storage check
        - nodeId: check-storage
          nodeName: Storage Validation Check
          type: Task
          runtimeType: CSharp
          assemblyPath: ExecutionEngine.Example.dll
          typeName: ExecutionEngine.Example.Nodes.AzureStackPreCheckNode
          configuration:
            checkType: "storage"

        # Child 3: Prerequisites check
        - nodeId: check-prerequisites
          nodeName: Prerequisites Check
          type: Task
          runtimeType: CSharp
          assemblyPath: ExecutionEngine.Example.dll
          typeName: ExecutionEngine.Example.Nodes.AzureStackPreCheckNode
          configuration:
            checkType: "prerequisites"

      # Sequential connections: Network → Storage → Prerequisites
      ChildConnections:
        - sourceNodeId: check-network
          targetNodeId: check-storage
          triggerMessageType: Complete
          isEnabled: true

        - sourceNodeId: check-storage
          targetNodeId: check-prerequisites
          triggerMessageType: Complete
          isEnabled: true

  # ============================================================================
  # Phase 2: Deploy to Nodes Container (Parallel Subflows)
  # ============================================================================

  - nodeId: node-deployments
    nodeName: Node Deployments
    runtimeType: Container
    configuration:
      ExecutionMode: "Parallel"
      ChildNodes:
        # Child 1: Deploy to Node1
        - nodeId: deploy-node1
          nodeName: Deploy to AzS-Node1
          runtimeType: Subflow
          configuration:
            WorkflowFilePath: "Workflows/deploy_node.yaml"
            InputMappings:
              nodeName: "nodeName"
            OutputMappings:
              deploymentStatus: "node1DeploymentStatus"
              osVersion: "node1OsVersion"
              stampVersion: "node1StampVersion"

        # Child 2: Deploy to Node2
        - nodeId: deploy-node2
          nodeName: Deploy to AzS-Node2
          runtimeType: Subflow
          configuration:
            WorkflowFilePath: "Workflows/deploy_node.yaml"
            InputMappings:
              nodeName: "nodeName"
            OutputMappings:
              deploymentStatus: "node2DeploymentStatus"
              osVersion: "node2OsVersion"
              stampVersion: "node2StampVersion"

        # Child 3: Deploy to Node3
        - nodeId: deploy-node3
          nodeName: Deploy to AzS-Node3
          runtimeType: Subflow
          configuration:
            WorkflowFilePath: "Workflows/deploy_node.yaml"
            InputMappings:
              nodeName: "nodeName"
            OutputMappings:
              deploymentStatus: "node3DeploymentStatus"
              osVersion: "node3OsVersion"
              stampVersion: "node3StampVersion"

      # No internal connections - all deployments run in parallel
      ChildConnections: []

  # ============================================================================
  # Phase 3: Post-deployment Health Checks Container (Sequential Execution)
  # ============================================================================

  - nodeId: health-checks
    nodeName: Post-Deployment Health Checks
    runtimeType: Container
    configuration:
      ExecutionMode: "Sequential"
      ChildNodes:
        # Child 1: Portal health check
        - nodeId: health-portal
          nodeName: Portal Service Health Check
          type: Task
          runtimeType: CSharp
          assemblyPath: ExecutionEngine.Example.dll
          typeName: ExecutionEngine.Example.Nodes.AzureStackHealthCheckNode
          configuration:
            serviceName: "Portal"

        # Child 2: ARM health check
        - nodeId: health-arm
          nodeName: ARM Service Health Check
          type: Task
          runtimeType: CSharp
          assemblyPath: ExecutionEngine.Example.dll
          typeName: ExecutionEngine.Example.Nodes.AzureStackHealthCheckNode
          configuration:
            serviceName: "ARM"

        # Child 3: Storage health check
        - nodeId: health-storage
          nodeName: Storage Service Health Check
          type: Task
          runtimeType: CSharp
          assemblyPath: ExecutionEngine.Example.dll
          typeName: ExecutionEngine.Example.Nodes.AzureStackHealthCheckNode
          configuration:
            serviceName: "Storage"

        # Child 4: Compute health check
        - nodeId: health-compute
          nodeName: Compute Service Health Check
          type: Task
          runtimeType: CSharp
          assemblyPath: ExecutionEngine.Example.dll
          typeName: ExecutionEngine.Example.Nodes.AzureStackHealthCheckNode
          configuration:
            serviceName: "Compute"

      # Sequential connections: Portal → ARM → Storage → Compute
      ChildConnections:
        - sourceNodeId: health-portal
          targetNodeId: health-arm
          triggerMessageType: Complete
          isEnabled: true

        - sourceNodeId: health-arm
          targetNodeId: health-storage
          triggerMessageType: Complete
          isEnabled: true

        - sourceNodeId: health-storage
          targetNodeId: health-compute
          triggerMessageType: Complete
          isEnabled: true

# ============================================================================
# External Workflow Connections
# ============================================================================
connections:
  # ----------------------------------------------------------------------------
  # Phase 1 → Phase 2: Pre-deployment checks complete → Start node deployments
  # Pre-deployment checks container triggers node deployments container
  # ----------------------------------------------------------------------------

  - sourceNodeId: pre-deployment-checks
    targetNodeId: node-deployments
    triggerMessageType: Complete
    isEnabled: true

  # ----------------------------------------------------------------------------
  # Phase 2 → Phase 3: All node deployments complete → Start health checks
  # Node deployments container triggers health checks container
  # ----------------------------------------------------------------------------

  - sourceNodeId: node-deployments
    targetNodeId: health-checks
    triggerMessageType: Complete
    isEnabled: true
